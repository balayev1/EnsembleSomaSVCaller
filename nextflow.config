params {
    // Main parameters
    input = "/projects/standard/aventeic/balay011/scripts/SomaCNV_chordbai.tsv"
    outdir = "/scratch.global/balay011/SomaticSV_outs"
    fasta = "/projects/standard/aventeic/balay011/references/reference_genome/GRCh38.primary_assembly.genome.fa"
    bed_file = null

    // ASCAT parameters
    allele_res = "/projects/standard/aventeic/balay011/references/SomaCNV_pip_files/ascat_files/allele_files"
    loci_res = "/projects/standard/aventeic/balay011/references/SomaCNV_pip_files/ascat_files/loci_files_fixed"
    gc_file = "/projects/standard/aventeic/balay011/references/SomaCNV_pip_files/ascat_files/other/GC_G1000_hg38.txt"
    rt_file = "/projects/standard/aventeic/balay011/references/SomaCNV_pip_files/ascat_files/other/RT_G1000_hg38.txt"
    genome_ver = "hg38"
    min_counts = 20
    min_basequal = 20
    min_mapqual = 35

    // SEQUENZA parameters
    bin_window = 50
    ploidy = null
    cellularity = null 
    ploidy_range = "1-7"
    cellularity_range = "0-1"
    store_seqztmp = false
    ignore_normal = false
    ratio_priority = false
    no_archive = true
    breaks_bed = null

    // FACETS parameters
    facets_snp_vcf = "/path/to/snps.vcf.gz" // required
    facets_mapq = 20
    facets_baq = 20
    facets_depth_min = 25
    facets_depth_max = 4000
    facets_cval_pre = 25

    // for targeted seq:
    // facets_cval_proc = 100

    // for exome:
    // facets_cval_proc = 150

    // for whole-genome:
    facets_cval_proc = 400

    facets_nbhd_snp = "auto"
    facets_gbuild = "hg38"
    facets_count_orphans = false
    facets_unmatched = false
    facets_no_cov_plot = false
    facets_targets_bed = null
    facets_annotation_bed = null
}

process {
    executor = 'slurm'

    withName: ASCAT {
        queue = 'asvnode1'
        cpus = 8
        // Using the dynamic memory logic for retries
        memory = { 64.GB * task.attempt }
        time   = '12h'
        errorStrategy = 'retry'
        maxRetries = 1

        ext.args = { [
            gender: meta.gender,
            genomeVersion: params.genome_ver,
            bed_file: params.bed_file,
            minCounts: params.min_counts,
            min_base_qual: params.min_basequal,
            min_map_qual: params.min_mapqual,
        ] }

        publishDir = [
            path: { "${params.outdir}/ascat/${meta.id}" },
            mode: 'copy'
        ] 
    }

    withName: SEQUENZAUTILS_GCWIGGLE {
        queue = 'asvnode1'
        cpus   = 1
        memory = { 32.GB * task.attempt }
        time   = '12h'
        errorStrategy = 'retry'
        maxRetries = 1

        ext.args = { [
            window: params.bin_window,
        ] }
        
        publishDir = [ path: { "${params.outdir}/sequenza/reference" }, mode: 'copy' ]
    }

    withName: SEQUENZA_RUN {
        queue = 'asvnode1'
        cpus   = 4
        memory = { 64.GB * task.attempt }
        time   = '24h'
        errorStrategy = 'retry'
        maxRetries = 2

        ext.args = { [
            bin_size: params.bin_window,
            ploidy: params.ploidy,
            cellularity: params.cellularity,
            ploidy_range: params.ploidy_range,
            cellularity_range: params.cellularity_range,
            store_seqztmp: params.store_seqztmp,
            ignore_normal: params.ignore_normal,
            ratio_priority: params.ratio_priority,
            no_archive: params.no_archive,
            breaks_file: params.breaks_bed,
            tmp_dir: params.tmp_dir
        ] }

        publishDir = [
            path: { "${params.outdir}/sequenza/${meta.id}" },
            mode: 'copy'
        ]
    }

    withName: FACETS {
        queue = 'asvnode1'
        cpus = 8
        memory = { 64.GB * task.attempt }
        time = '12h'
        errorStrategy = 'retry'
        maxRetries = 1

        ext.args = { [
            snp_mapq: params.facets_mapq,
            snp_baq: params.facets_baq,
            snp_nprocs: task.cpus,
            depth_min: params.facets_depth_min,
            depth_max: params.facets_depth_max,
            cval_pre: params.facets_cval_pre,
            cval_proc: params.facets_cval_proc,
            nbhd_snp: params.facets_nbhd_snp,
            gbuild: params.facets_gbuild,
            snp_count_orphans: params.facets_count_orphans,
            unmatched: params.facets_unmatched,
            no_cov_plot: params.facets_no_cov_plot,
        ] }

        publishDir = [
            path: { "${params.outdir}/facets/${meta.id}" },
            mode: 'copy'
        ]
    }
}


profiles {
    singularity {
        singularity.enabled    = true
        singularity.autoMounts = true
        singularity.runOptions = '--bind /projects/standard/aventeic/balay011,/scratch.global/balay011'
    }
}