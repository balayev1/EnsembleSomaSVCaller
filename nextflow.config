params {
    input = "/projects/standard/aventeic/balay011/scripts/SomaCNV_chordbai.csv"
    outdir = "/scratch.global/balay011/SomaticSV_outs"

    // Path to BED file (e.g., exome targets or specific regions)
    bed_file = "/projects/standard/aventeic/balay011/references/reference_genome/Homo_sapiens_assembly38_chrs.bed"

    // Required file paths
    fasta = "/projects/standard/aventeic/balay011/references/reference_genome/GRCh38.primary_assembly.genome.fa"
    allele_res = "/projects/standard/aventeic/balay011/references/SomaCNV_pip_files/ascat_files/allele_files"
    loci_res = "/projects/standard/aventeic/balay011/references/SomaCNV_pip_files/ascat_files/loci_files_fixed"
    gc_file = "/projects/standard/aventeic/balay011/references/SomaCNV_pip_files/ascat_files/other/GC_G1000_hg38.txt"
    rt_file = "/projects/standard/aventeic/balay011/references/SomaCNV_pip_files/ascat_files/other/RT_G1000_hg38.txt"

    // ASCAT Settings
    genome_ver = "hg38"
    min_counts = 20
    min_basequal = 20
    min_mapqual = 35

    // SEQUENZA Settings
    bin_window = 50
    min_reads_normal = 20
    min_reads_baf = 20
    gamma = [50, 100, 200, 300, 400, 500, 600, 700, 800, 900, 1000, 1250, 1500, 2000]
}

process {
    executor = 'slurm'

    withName: ASCAT {
        queue = 'asvnode1'
        cpus = 8
        // Using the dynamic memory logic for retries
        memory = { 64.GB * task.attempt }
        time   = '12h'
        errorStrategy = 'retry'
        maxRetries = 1

        ext.args = { [
            gender: meta.gender,
            genomeVersion: params.genome_ver,
            minCounts: params.min_counts,
            min_base_qual: params.min_basequal,
            min_map_qual: params.min_mapqual,
        ] }

        publishDir = [
            path: { "${params.outdir}/ascat/${meta.id}" },
            mode: 'copy'
        ] 
    }

    withName: SEQUENZAUTILS_GCWIGGLE {
        cpus   = 1
        memory = { 32.GB * task.attempt }
        errorStrategy = 'retry'
        maxRetries = 3
        publishDir = [ path: { "${params.outdir}/sequenza/reference" }, mode: 'copy' ]
    }

    withName: SEQUENZAUTILS_BAM2SEQZ {
        cpus   = 8
        memory = { 64.GB * task.attempt }
        time   = '24h'
        publishDir = [ path: { "${params.outdir}/sequenza/${meta.id}/raw_seqz" }, mode: 'copy', enabled: false ]
    }

    withName: SEQUENZAUTILS_BINNING {
        cpus   = 2
        memory = 16.GB
        ext.args = { [
            window: params.bin_window,
        ] }
        publishDir = [ path: { "${params.outdir}/sequenza/${meta.id}/binned" }, mode: 'copy' ]
    }

    withName: SEQUENZA_RUN {
        cpus   = 4
        memory = { 32.GB * task.attempt }
        time   = '24h'
        ext.args = { [
            ref_assembly: params.genome_ver,
            window: params.bin_window,
            min_reads_normal: params.min_reads_normal,
            min_reads_baf: params.min_reads_baf
        ] }
        publishDir = [
            path: { "${params.outdir}/sequenza/${meta.id}/results_g${gamma}" },
            mode: 'copy'
        ]
    }
}


profiles {
    singularity {
        singularity.enabled    = true
        singularity.autoMounts = true
        singularity.runOptions = '--bind /projects/standard/aventeic/balay011,/scratch.global/balay011'
    }
}